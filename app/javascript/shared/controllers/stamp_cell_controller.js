import { Controller } from "stimulus"
import { autorun, computed } from 'mobx'
import { html, render } from 'lit-html'
import { repeat } from 'lit-html/directives/repeat'
import { flatten, kebabCase, without } from 'lodash'

export default class extends Controller {

  showModal(event) {
    showModal({
      html: '<form id="new_bulk_shift_form_form" data-controller="bulk-shifts--form helpers--form-states helpers--forms" data-action="helpers--forms#submit ajax:error->helpers--forms#ajaxError ajax:success->helpers--forms#ajaxSuccess" data-helpers--forms-refresh-path="/42385/bulk/shift/new" action="/42385/bulk/shift" accept-charset="UTF-8" data-remote="true" method="post"><input type="hidden" name="authenticity_token" value="lAZlH4POSr5S9EicbjpoJ0Jiqqxy+27s5sZl6oj+ZeH2oWtSjAwAFII/afWK+diEVQJucIYMH9G5DNTFygkC/w=="><div class="modal-header" data-target="helpers--forms.refreshWrapper">New Shift<div class="button-group-field" data-controller="fields--button-group-field"><input collection="fields conflict duplicate" data-action="helpers--form-states#toggleState" data-target="helpers--form-states.input fields--button-group-field.hiddenInput" conflict_badge="{:color=>:red, :value=>nil}" model="BulkShiftForm" schedule="#<Schedule:0x00007fe26523abf0>" type="hidden" value="duplicate" name="bulk_shift_form[form_state]" id="bulk_shift_form_form_state"><a class="btn fields" data-target="fields--button-group-field.button" data-action="fields--button-group-field#clickButton" data-value="fields">Details</a><a class="btn conflict" data-target="fields--button-group-field.button" data-action="fields--button-group-field#clickButton" data-value="conflict">Errors</a><a class="btn duplicate active" data-target="fields--button-group-field.button" data-action="fields--button-group-field#clickButton" data-value="duplicate">Copy</a></div></div><div class="modal-body"><div data-form-state="fields" data-target="helpers--form-states.formStateWrapper" class="d-none"><div class="form-row"><div class="form-group"><label for="bulk_shift_form_assignment_ids">Team Members</label><div class="select-list-wrapper" data-controller="fields--select-list-field" data-divider-name="Members" data-divider-values="[]" data-selected-values="[&quot;&quot;]"><input multiple="multiple" type="hidden" name="bulk_shift_form[assignment_ids][]" id="bulk_shift_form_assignment_ids"><div class="select-list-bulk-controls" style="display: none;"><a data-action="fields--select-list-field#clearAll">Clear</a></div><div class="dropdown" style="max-width: 540px;"><a class="btn btn-input" data-flip="false" data-toggle="dropdown" data-target="fields--select-list-field.button" data-action="fields--select-list-field#focusSearch"><div class="select-list-item-label">Open Shift</div></a><div class="dropdown-menu"><div class="select-list" data-action="click->fields--select-list-field#preventDropdownClose"><div class="select-list-items" data-target="fields--select-list-field.list"><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="bulk-shifts--form#toggleAssignment fields--select-list-field#updateButton" data-target="bulk-shifts--form.assignmentIdsInput fields--select-list-field.itemInput" class="form-check-input" type="checkbox" value="" name="bulk_shift_form[assignment_ids][]" id="bulk_shift_form_assignment_ids_"><div class="select-list-item-label">Open Shift</div></label><div class="select-list-divider">Members</div><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="bulk-shifts--form#toggleAssignment fields--select-list-field#updateButton" data-target="bulk-shifts--form.assignmentIdsInput fields--select-list-field.itemInput" class="form-check-input" type="checkbox" value="341240" name="bulk_shift_form[assignment_ids][]" id="bulk_shift_form_assignment_ids_341240"><div class="select-list-item-label">Ryo Matsumura</div></label></div></div></div></div></div></div><input id="previousAssignmentIDs" multiple="multiple" data-target="bulk-shifts--form.previousAssignmentIds" type="hidden" value="" name="bulk_shift_form[assignment_ids][]"><div class=" form-group" style="max-width:120px" data-target="bulk-shifts--form.quantityField"><label for="bulk_shift_form_quantity">Shift Slots</label><input placeholder="e.g. 5" class="form-control" type="number" value="1" name="bulk_shift_form[quantity]" id="bulk_shift_form_quantity"></div><div style="max-width:120px" class="form-group"><label for="bulk_shift_form_wage_dollars">Hourly Wage</label><div class="input-group"><div class="input-group-prepend"><div class="input-group-text">$</div></div><input data-toggle="tooltip" title="" data-placement="left" step="any" min="0" placeholder="e.g. 8.75" class="form-control" type="number" value="0" name="bulk_shift_form[wage_dollars]" id="bulk_shift_form_wage_dollars" data-original-title="Leave blank to use the default Hourly Wage set for each Team Member on the Team screen. Enter a value to set a custom rate for this Shift."></div></div><a class="wage-help-link" data-action="helpers--links#click" data-controller="helpers--links" href=" https://help.zoomshift.com/article/63-multi-shift-assignments" target="blank"><i class="icon-question-circle"></i></a><input type="hidden" value="true" name="bulk_shift_form[wage_flag]" id="bulk_shift_form_wage_flag"></div><div class="form-row"><div class="form-group"><label for="bulk_shift_form_position_id">Position</label><div class="select-list-wrapper" data-controller="fields--select-list-field" data-divider-name="Positions" data-divider-values="[]" data-selected-values="[&quot;&quot;]"><div class="dropdown"><a class="btn btn-input" data-flip="false" data-toggle="dropdown" data-target="fields--select-list-field.button" data-action="fields--select-list-field#focusSearch"><div class="select-list-item-label">No Position</div></a><div class="dropdown-menu"><div class="select-list"><div class="select-list-items" data-target="fields--select-list-field.list"><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="fields--select-list-field#updateButton" data-target="fields--select-list-field.itemInput" type="radio" value="" name="bulk_shift_form[position_id]" id="bulk_shift_form_position_id_"><div class="select-list-item-label">No Position</div></label><div class="select-list-divider">Positions</div><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="fields--select-list-field#updateButton" data-target="fields--select-list-field.itemInput" type="radio" value="96046" name="bulk_shift_form[position_id]" id="bulk_shift_form_position_id_96046"><div class="select-list-item-label"><i class="icon-circle" style="color: #8a8a48"></i> ホール</div></label><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="fields--select-list-field#updateButton" data-target="fields--select-list-field.itemInput" type="radio" value="96045" name="bulk_shift_form[position_id]" id="bulk_shift_form_position_id_96045"><div class="select-list-item-label"><i class="icon-circle" style="color: #7935e8"></i> 調理</div></label></div></div></div></div></div></div><div class="form-group"><label for="bulk_shift_form_location_id">Location</label><div class="select-list-wrapper" data-controller="fields--select-list-field" data-divider-name="Locations" data-divider-values="[]" data-selected-values="[&quot;&quot;]"><div class="dropdown"><a class="btn btn-input" data-flip="false" data-toggle="dropdown" data-target="fields--select-list-field.button" data-action="fields--select-list-field#focusSearch"><div class="select-list-item-label">No Location</div></a><div class="dropdown-menu"><div class="select-list"><div class="select-list-items" data-target="fields--select-list-field.list"><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="fields--select-list-field#updateButton" data-target="fields--select-list-field.itemInput" type="radio" value="" name="bulk_shift_form[location_id]" id="bulk_shift_form_location_id_"><div class="select-list-item-label">No Location</div></label><div class="select-list-divider">Locations</div></div></div></div></div></div></div><input type="hidden" value="false" name="bulk_shift_form[multiple_positions]" id="bulk_shift_form_multiple_positions"><input type="hidden" value="false" name="bulk_shift_form[multiple_locations]" id="bulk_shift_form_multiple_locations"><input type="hidden" name="bulk_shift_form[previous_assignment]" id="bulk_shift_form_previous_assignment"><a class="position-help-link" data-action="helpers--links#click" data-controller="helpers--links" href=" https://help.zoomshift.com/article/63-multi-shift-assignments" target="blank"><i class="icon-question-circle"></i></a><a class="location-help-link" data-action="helpers--links#click" data-controller="helpers--links" href=" https://help.zoomshift.com/article/63-multi-shift-assignments" target="blank"><i class="icon-question-circle"></i></a></div><div class="form-row"><div class="shift-date-field-wrapper"><div class="form-group"><label for="bulk_shift_form_date">Date</label><div data-controller="fields--date-field"><input data-target="fields--date-field.hiddenInput" data-action="helpers--forms#triggerRefresh" type="hidden" value="2020-09-19" name="bulk_shift_form[date]" id="bulk_shift_form_date"><input data-target="fields--date-field.input" class="form-control" type="text" value="2020-09-19" id="bulk_shift_form_date"></div></div><div class="no-pulse form-group" data-target="helpers--forms.refreshWrapper"><div class="select-list-wrapper" data-controller="fields--select-list-field" data-divider-name="Not assigned to position/location:" data-divider-values="[91220,91221,91222]"><div class="dropdown"><a class="btn btn-input" data-flip="false" data-toggle="dropdown" data-target="fields--select-list-field.button" data-action="fields--select-list-field#focusSearch"><div class="placeholder">Click to select...</div></a><div class="dropdown-menu"><div class="select-list"><div class="select-list-items" data-target="fields--select-list-field.list"><label class="select-list-item" data-target="fields--select-list-field.item" data-action="click->shifts--form#selectShiftTemplate" data-break-time="0" data-start-time="8:30am" data-end-time="1:30pm"><input data-action="fields--select-list-field#updateButton helpers--forms#triggerRefresh" data-target="fields--select-list-field.itemInput" type="radio" value="91220" name="bulk_shift_form[shift_template_id]" id="bulk_shift_form_shift_template_id_91220"><div class="select-list-item-label">8:30am - 1:30pm</div></label><label class="select-list-item" data-target="fields--select-list-field.item" data-action="click->shifts--form#selectShiftTemplate" data-break-time="0" data-start-time="10:00am" data-end-time="5:00pm"><input data-action="fields--select-list-field#updateButton helpers--forms#triggerRefresh" data-target="fields--select-list-field.itemInput" type="radio" value="91221" name="bulk_shift_form[shift_template_id]" id="bulk_shift_form_shift_template_id_91221"><div class="select-list-item-label">10am - 5pm</div></label><label class="select-list-item" data-target="fields--select-list-field.item" data-action="click->shifts--form#selectShiftTemplate" data-break-time="0" data-start-time="1:30pm" data-end-time="10:00pm"><input data-action="fields--select-list-field#updateButton helpers--forms#triggerRefresh" data-target="fields--select-list-field.itemInput" type="radio" value="91222" name="bulk_shift_form[shift_template_id]" id="bulk_shift_form_shift_template_id_91222"><div class="select-list-item-label">1:30pm - 10pm</div></label><div class="select-list-divider">Not assigned to position/location:</div></div></div></div></div></div></div></div><div class="phone-divider"></div><div class="form-group"><label for="bulk_shift_form_start_time">Start Time</label><input data-target="bulk-shifts--form.startTimeField" data-action="timeChanged->helpers--forms#triggerRefresh" data-controller="fields--time-field" placeholder="e.g. 10am" class="form-control ui-timepicker-input" type="text" value="8:00am" name="bulk_shift_form[start_time]" id="bulk_shift_form_start_time" autocomplete="off" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABHklEQVQ4EaVTO26DQBD1ohQWaS2lg9JybZ+AK7hNwx2oIoVf4UPQ0Lj1FdKktevIpel8AKNUkDcWMxpgSaIEaTVv3sx7uztiTdu2s/98DywOw3Dued4Who/M2aIx5lZV1aEsy0+qiwHELyi+Ytl0PQ69SxAxkWIA4RMRTdNsKE59juMcuZd6xIAFeZ6fGCdJ8kY4y7KAuTRNGd7jyEBXsdOPE3a0QGPsniOnnYMO67LgSQN9T41F2QGrQRRFCwyzoIF2qyBuKKbcOgPXdVeY9rMWgNsjf9ccYesJhk3f5dYT1HX9gR0LLQR30TnjkUEcx2uIuS4RnI+aj6sJR0AM8AaumPaM/rRehyWhXqbFAA9kh3/8/NvHxAYGAsZ/il8IalkCLBfNVAAAAABJRU5ErkJggg==&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;"></div><div class="form-group"><label for="bulk_shift_form_end_time">End Time</label><input data-target="bulk-shifts--form.endTimeField" data-action="timeChanged->helpers--forms#triggerRefresh" data-controller="fields--time-field" placeholder="e.g. 5pm" class="form-control ui-timepicker-input" type="text" value="1:30pm" name="bulk_shift_form[end_time]" id="bulk_shift_form_end_time" autocomplete="off"></div><div style="max-width:120px" class="form-group"><label for="bulk_shift_form_break_time_minutes">Unpaid Break</label><div class="input-group"><input duration="min" data-target="bulk-shifts--form.breakTimeField" data-action="helpers--forms#triggerRefresh" step="any" placeholder="e.g. 15" class="form-control" type="number" name="bulk_shift_form[break_time_minutes]" id="bulk_shift_form_break_time_minutes"><div class="input-group-append"><div class="input-group-text">min</div></div></div></div></div><div class="form-group"><label for="bulk_shift_form_note">Note</label><textarea data-target="bulk-shifts--form.noteField" placeholder="e.g. Any other information you want to include..." class="form-control" name="bulk_shift_form[note]" id="bulk_shift_form_note"></textarea></div><div class="" data-target="bulk-shifts--form.notAssignedFields"><div class="modal-divider">Open Shift Options</div><div class="form-group"><label for="bulk_shift_form_public">Public Offer</label><div class="toggle-well"><div class="form-text">Offer this shift to everyone who is eligible to pick it up. If not, you can pick specific team members to offer it to.</div><div class="toggle-field" data-controller="fields--toggle-field"><input data-action="bulk-shifts--form#togglePublic" data-target="bulk-shifts--form.publicInput fields--toggle-field.hiddenInput" type="hidden" value="true" name="bulk_shift_form[public]" id="bulk_shift_form_public"><a class="toggle-switch on animate" data-target="fields--toggle-field.switch" data-action="fields--toggle-field#clickSwitch"></a></div></div></div><div data-target="bulk-shifts--form.publicFields" class="form-group d-none"><label for="bulk_shift_form_import_offer_assignment_ids">Offer to Team Members</label><div class="select-list-wrapper" data-controller="fields--select-list-field" data-divider-name="Offer to Team Members" data-divider-values="[]"><input multiple="multiple" type="hidden" name="bulk_shift_form[import_offer_assignment_ids][]" id="bulk_shift_form_import_offer_assignment_ids"><div class="select-list-bulk-controls"><a data-action="fields--select-list-field#selectAll">All</a><a data-action="fields--select-list-field#clearAll">Clear</a></div><div class="dropdown"><a class="btn btn-input" data-flip="false" data-toggle="dropdown" data-target="fields--select-list-field.button" data-action="fields--select-list-field#focusSearch"><div class="placeholder">Click to select...</div></a><div class="dropdown-menu"><div class="select-list" data-action="click->fields--select-list-field#preventDropdownClose"><div class="select-list-items" data-target="fields--select-list-field.list"><div class="select-list-divider">Offer to Team Members</div><label class="select-list-item" data-target="fields--select-list-field.item"><input data-action="fields--select-list-field#updateButton" data-target="fields--select-list-field.itemInput" class="form-check-input" type="checkbox" value="341240" name="bulk_shift_form[import_offer_assignment_ids][]" id="bulk_shift_form_import_offer_assignment_ids_341240"><div class="select-list-item-label">Ryo Matsumura</div></label></div></div></div></div></div></div></div><script>  $(".tooltip").tooltip("hide");  $("#bulk_shift_form_assignment_ids").next().next().css("max-width", "540px");  $("#bulk_shift_form_assignment_ids").next().hide();    if ($("#bulk_shift_form_wage_flag").val() == "false") {    $("#bulk_shift_form_wage_dollars").css("background-color", "#F8FAFC");    $("#bulk_shift_form_wage_dollars").val("");  }    $("#bulk_shift_form_wage_dollars").on("click",function(){    $("#bulk_shift_form_wage_dollars").removeAttr("style");    $("#bulk_shift_form_wage_flag").val("clicked");  });    $("[data-toggle="tooltip"]").tooltip();</script></div><div data-form-state="conflict" data-target="helpers--form-states.formStateWrapper" class="d-none"><div class="form-group"><label for="bulk_shift_form_ignore_conflict">Ignore Shift Error Rules</label><div class="toggle-well"><div class="form-text">Ignore the shift error rules and save this shift anyways.</div><div class="toggle-field" data-controller="fields--toggle-field"><input data-target="fields--toggle-field.hiddenInput" type="hidden" name="bulk_shift_form[ignore_conflict]" id="bulk_shift_form_ignore_conflict"><a class="toggle-switch off animate" data-target="fields--toggle-field.switch" data-action="fields--toggle-field#clickSwitch"></a></div></div></div><p>The table below is a breakdown of your error rules for this shift. If a rule triggers a flag, this shift can still be saved, but it will show as having an error. If a rule triggers a block, this shift will not save unless you ignore the rules using the toggle above.</p><div class="settings-table"><div class="table-header"><div class="table-row"><div class="table-cell">Rule</div><div class="table-cell small">Status</div></div></div><div class="table-body" data-target="helpers--forms.refreshWrapper"><div class="table-row"><div class="table-cell">Does this shift overlap with availability?</div><div class="table-cell text-600 small"><span class="text-green"><i class="icon-check-circle-o"></i>Passed</span></div></div><div class="table-row"><div class="table-cell">Does this shift overlap with an existing shift?</div><div class="table-cell text-600 small"><span class="text-green"><i class="icon-check-circle-o"></i>Passed</span></div></div><div class="table-row"><div class="table-cell">Does this shift break the daily overtime limit?</div><div class="table-cell text-600 small"><span class="text-green"><i class="icon-check-circle-o"></i>Passed</span></div></div><div class="table-row"><div class="table-cell">Does this shift break the weekly overtime limit?</div><div class="table-cell text-600 small"><span class="text-green"><i class="icon-check-circle-o"></i>Passed</span></div></div><div class="table-row"><div class="table-cell">Does this shift overlap with a time off request?</div><div class="table-cell text-600 small"><span class="text-green"><i class="icon-check-circle-o"></i>Passed</span></div></div></div></div></div><div data-form-state="duplicate" data-target="helpers--form-states.formStateWrapper" class=""><div data-controller="helpers--duplicate-fields" data-helpers--duplicate-fields-current-weekday="6" data-target="helpers--forms.refreshWrapper"><div class="form-group"><label for="bulk_shift_form_duplicate_days">Copy to Other Weekdays</label><div class="select-list-wrapper" data-controller="fields--select-list-field"><input multiple="multiple" type="hidden" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days"><div class="select-list" data-action="click->fields--select-list-field#preventDropdownClose"><div class="select-list-items" data-target="fields--select-list-field.list"><label class="select-list-item" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="0" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_0"><div class="select-list-item-label">Sunday</div></label><label class="select-list-item" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="1" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_1"><div class="select-list-item-label">Monday</div></label><label class="select-list-item" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="2" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_2"><div class="select-list-item-label">Tuesday</div></label><label class="select-list-item" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="3" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_3"><div class="select-list-item-label">Wednesday</div></label><label class="select-list-item" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="4" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_4"><div class="select-list-item-label">Thursday</div></label><label class="select-list-item" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="5" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_5"><div class="select-list-item-label">Friday</div></label><label class="select-list-item disabled" data-target="fields--select-list-field.item"><input data-target="helpers--duplicate-fields.duplicateDayInput fields--select-list-field.itemInput" data-action="fields--select-list-field#updateButton" class="form-check-input" type="checkbox" value="6" name="bulk_shift_form[duplicate_days][]" id="bulk_shift_form_duplicate_days_6" disabled=""><div class="select-list-item-label">Saturday</div></label></div></div></div><div class="form-text">Select the other weekdays you would like to copy this shift to. This shift is currently scheduled on a Saturday, which is why you can"t deselect this option.</div></div><div class="form-group"><label for="bulk_shift_form_duplicate_future">Copy to Future Weeks</label><div class="toggle-well"><div class="form-text">Copy this shift to future weeks too.</div><div class="toggle-field" data-controller="fields--toggle-field"><input data-action="helpers--duplicate-fields#toggleFuture" data-target="helpers--duplicate-fields.futureInput fields--toggle-field.hiddenInput" type="hidden" name="bulk_shift_form[duplicate_future]" id="bulk_shift_form_duplicate_future"><a class="toggle-switch off animate" data-target="fields--toggle-field.switch" data-action="fields--toggle-field#clickSwitch"></a></div></div></div><div class="form-row d-none" data-target="helpers--duplicate-fields.futureFields"><div class="form-group"><label for="bulk_shift_form_duplicate_interval">Occurring Every</label><select class="form-control" name="bulk_shift_form[duplicate_interval]" id="bulk_shift_form_duplicate_interval"><option value="1">Week</option><option value="2">2 Weeks</option><option value="3">3 Weeks</option><option value="4">4 Weeks</option></select></div><div class="form-group"><label for="bulk_shift_form_duplicate_until">Until</label><div data-controller="fields--date-field"><input data-target="fields--date-field.hiddenInput" type="hidden" name="bulk_shift_form[duplicate_until]" id="bulk_shift_form_duplicate_until" value="2020-09-19"><input data-target="fields--date-field.input" class="form-control" type="text" id="bulk_shift_form_duplicate_until"></div></div></div></div><script>  $( document ).ready(function() {    var week_day = "6";    $("#bulk_shift_form_duplicate_days").next().find("input[value=" + week_day +"]").prop( "checked", true )  });</script></div></div><div class="modal-footer"><div class="label" id="selectedMemberCount">You selected 0 Members Total</div><button name="bulk_shift_form[published]" type="submit" value="true" class="btn btn-default" data-target="helpers--forms.submitButton">Save &amp; Publish</button><button type="submit" class="btn btn-blue" data-target="helpers--forms.submitButton">Save</button></div></form>'
    })
  }
}